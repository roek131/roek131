<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="include/layout">
<th:block layout:fragment="page_head">
	<title>글쓰기</title>
	<script>
	$(document).ready(function() {
		//파일 업로드
		
		 // 파일 리스트 번호
	    var fileIndex = 0;
	    // 등록할 전체 파일 사이즈
	    var totalFileSize = 0;
	    // 파일 리스트
	    var fileList = new Array();
	    // 파일 사이즈 리스트
	    var fileSizeList = new Array();
	    // 등록 가능한 파일 사이즈 MB
	    var uploadSize = 50;
	    // 등록 가능한 총 파일 사이즈 MB
	    var maxUploadSize = 500;
	 
	    $(function (){
	        // 파일 드롭 다운
	        fileDropDown();
	    });
	 
	    // 파일 드롭 다운
	    function fileDropDown(){
	        var dropZone = $("#dropZone");
	        //Drag기능 
	        dropZone.on('dragenter',function(e){
	            e.stopPropagation();
	            e.preventDefault();
	            // 드롭다운 영역 css
	            dropZone.css('background-color','#E3F2FC');
	        });
	        dropZone.on('dragleave',function(e){
	            e.stopPropagation();
	            e.preventDefault();
	            // 드롭다운 영역 css
	            dropZone.css('background-color','#FFFFFF');
	        });
	        dropZone.on('dragover',function(e){
	            e.stopPropagation();
	            e.preventDefault();
	            // 드롭다운 영역 css
	            dropZone.css('background-color','#E3F2FC');
	        });
	        dropZone.on('drop',function(e){
	            e.preventDefault();
	            // 드롭다운 영역 css
	            dropZone.css('background-color','#FFFFFF');
	            
	            var files = e.originalEvent.dataTransfer.files;
	            if(files != null){
	                if(files.length < 1){
	                    alert("폴더 업로드 불가");
	                    return;
	                }
	                selectFile(files)
	            }else{
	                alert("ERROR");
	            }
	        });
	    }
	 
	    // 파일 선택시
	    function selectFile(files){
	        // 다중파일 등록
	        if(files != null){
	            for(var i = 0; i < files.length; i++){
	                // 파일 이름
	                var fileName = files[i].name;
	                var fileNameArr = fileName.split("\.");
	                // 확장자
	                var ext = fileNameArr[fileNameArr.length - 1];
	                // 파일 사이즈(단위 :MB)
	                var fileSize = files[i].size / 1024 / 1024;
	                
	                if($.inArray(ext, ['exe', 'bat', 'sh', 'java', 'jsp', 'html', 'js', 'css', 'xml']) >= 0){
	                    // 확장자 체크
	                    alert("등록 불가 확장자");
	                    break;
	                }else if(fileSize > uploadSize){
	                    // 파일 사이즈 체크
	                    alert("용량 초과\n업로드 가능 용량 : " + uploadSize + " MB");
	                    break;
	                }else{
	                    // 전체 파일 사이즈
	                    totalFileSize += fileSize;
	                    
	                    // 파일 배열에 넣기
	                    fileList[fileIndex] = files[i];
	                    
	                    // 파일 사이즈 배열에 넣기
	                    fileSizeList[fileIndex] = fileSize;
	 
	                    // 업로드 파일 목록 생성
	                    addFileList(fileIndex, fileName, fileSize);
	 
	                    // 파일 번호 증가
	                    fileIndex++;
	                }
	            }
	        }else{
	            alert("ERROR");
	        }
	    }
	 
	    // 업로드 파일 목록 생성
	    function addFileList(fIndex, fileName, fileSize){
	        var html = "";
	        html += "<tr id='fileTr_" + fIndex + "'>";
	        html += "    <td class='left' >";
	        html +=         fileName + " / " + fileSize + "MB "  + "<a href='#' onclick='deleteFile(" + fIndex + "); return false;' class='btn small bg_02'>삭제</a>"
	        html += "    </td>"
	        html += "</tr>"
	 
	        $('#fileTableTbody').append(html);
	    }
	 
	    // 업로드 파일 삭제
	    function deleteFile(fIndex){
	        // 전체 파일 사이즈 수정
	        totalFileSize -= fileSizeList[fIndex];
	        
	        // 파일 배열에서 삭제
	        delete fileList[fIndex];
	        
	        // 파일 사이즈 배열 삭제
	        delete fileSizeList[fIndex];
	        
	        // 업로드 파일 테이블 목록에서 삭제
	        $("#fileTr_" + fIndex).remove();
	    }
	 
	    // 파일 등록
	  
	        // 등록할 파일 리스트
	        var uploadFileList;
	            
	            
	     
	    
		$("#postups").click(function() {
			var titles= $('#titles').val();
			var context = $('#context').val();
			
			uploadFileList = Object.keys(fileList);
				 
		        // 파일이 있는지 체크
		        if(uploadFileList.length == 0){
		            // 파일등록 경고창
		            alert("파일이 없습니다.");
		            return;
		        }
		        
		        // 용량을 500MB를 넘을 경우 업로드 불가
		        if(totalFileSize > maxUploadSize){
		            // 파일 사이즈 초과 경고창
		            alert("총 용량 초과\n총 업로드 가능 용량 : " + maxUploadSize + " MB");
		            return;
		        }
		            
		       
		            // 등록할 파일 리스트를 formData로 데이터 입력
		           
			
		    if(titles==""){
				alert("제목입력해주세여");
			}if(context==""){
				alert("내용을 적어주세요");
			}else{
		var query =  {	title : $('#titles').val(), context : $('#context').val()
				};
				console.log($("#titles"));
				console.log($("#titles").val());
//				insert ajax
	 		$.ajax({
			    	url: "/newboard",
			    	type: "POST",
			    	data : query,
			    	dataType: "json", // controller return을 json으로 받음
			    	success : function(data){
			    		 var form = $('#uploadForm');
				            console.log($('#uploadForm'));
				            var formData = new FormData(document.getElementById("uploadForm"));
				            console.log(formData);
				            for(var i = 0; i < uploadFileList.length; i++){
				                formData.append('files', fileList[uploadFileList[i]]);
				                console.log(formData);
				                console.log(fileList);
				                
				            }
			    		 $.ajax({
				                url:"/fileUpload",
				                data:formData,
				                type:'POST',
				                enctype:'multipart/form-data',
				                processData:false,
				                contentType:false,
				                dataType:'json',
				                cache:false,
				                success:function(data){
				                	 console.log(data);
				                     if(data.name.length > 0){
				                        alert("작성완료");
				                    /*     window.location = "/"; */
				                   
				                    }else{
				                        alert("실패");
				                 
				                    } 
				                }
				            }); 
			    	}, error: function(data) {
			    		console.log(data);
			    	}
			
			});  
			}
		});
	});
	
	</script>
	<style>

        </style>

</th:block>

<!-- page_lib와 page_css 는 위와 같이 추가하여 사용-->
<th:block layout:fragment="contents">
<h3>게시글 작성</h3>
    <div style="padding : 30px;">
          <div class="form-group">
            <label>제목</label>
            <input type="text" class="form-control" id="titles">
          </div>

          <div class="form-group">
            <label>내용</label>
            <textarea name="content" class="form-control" rows="15" id="context"></textarea>
          </div>
          <div class="form-group">
			<label>파일</label>
			
		
		 
  <form name="uploadForm" id="uploadForm" enctype="multipart/form-data" method="post">
        <table class="table" width="100%" border="1px">
            <tbody id="fileTableTbody">
                <tr>
                    <td id="dropZone">
                        파일을 드래그 하세요
                    </td>
                </tr>
            </tbody>
        </table>
    </form>

          </div>
          <button type="button" class="btn btn-primary" id="postups">글쓰기</button>
</div>
</th:block>
<!-- page_js 필요하면 추가 -->
</html>